<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Jeopardy!</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --board-blue: #060CE9;
  --dark-blue: #000080;
  --gold: #D7A32A;
  --white: #fff;
  --correct: #4CAF50;
  --incorrect: #F44336;
}

@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&display=swap');

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #1a1a2e;
  color: var(--white);
  min-height: 100vh;
  min-height: 100dvh;
  overflow-x: hidden;
}

/* ─── Lobby ──────────────────────────────────────────────────── */
#lobby {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  min-height: 100dvh;
  padding: 20px;
  text-align: center;
}

.lobby-title {
  font-family: 'Playfair Display', serif;
  font-size: 3rem;
  color: var(--gold);
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  margin-bottom: 8px;
}

.lobby-subtitle {
  color: #aaa;
  margin-bottom: 32px;
  font-size: 0.9rem;
}

.lobby-card {
  background: rgba(255,255,255,0.08);
  border-radius: 16px;
  padding: 32px;
  width: 100%;
  max-width: 420px;
  backdrop-filter: blur(10px);
}

.lobby-card h2 {
  margin-bottom: 20px;
  font-size: 1.2rem;
}

.lobby-input {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid rgba(255,255,255,0.2);
  border-radius: 8px;
  background: rgba(255,255,255,0.05);
  color: var(--white);
  font-size: 1rem;
  margin-bottom: 12px;
  outline: none;
  transition: border-color 0.2s;
}
.lobby-input:focus { border-color: var(--gold); }
.lobby-input::placeholder { color: rgba(255,255,255,0.4); }

.lobby-btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.1s, opacity 0.2s;
  margin-bottom: 8px;
}
.lobby-btn:active { transform: scale(0.97); }
.lobby-btn:disabled { opacity: 0.5; cursor: default; }

.btn-gold { background: var(--gold); color: #1a1a2e; }
.btn-blue { background: var(--board-blue); color: var(--white); }
.btn-outline {
  background: transparent;
  color: var(--gold);
  border: 2px solid var(--gold);
}

.lobby-or {
  color: #666;
  margin: 12px 0;
  font-size: 0.85rem;
}

.room-code-display {
  font-family: monospace;
  font-size: 2.5rem;
  font-weight: 900;
  letter-spacing: 8px;
  color: var(--gold);
  margin: 16px 0;
}

.player-list {
  list-style: none;
  margin: 16px 0;
}
.player-list li {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 0;
  font-size: 0.95rem;
}
.player-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
}
.player-host {
  font-size: 0.7rem;
  background: var(--gold);
  color: #1a1a2e;
  padding: 2px 6px;
  border-radius: 4px;
  margin-left: auto;
}

.game-info {
  color: #888;
  font-size: 0.8rem;
  margin-top: 12px;
}

/* ─── Game Container ─────────────────────────────────────────── */
#game { display: none; }
#game.active { display: flex; flex-direction: column; min-height: 100vh; min-height: 100dvh; }

/* Scores bar */
.scores-bar {
  display: flex;
  justify-content: center;
  gap: 16px;
  padding: 10px 16px;
  background: var(--dark-blue);
  flex-wrap: wrap;
}
.score-item {
  text-align: center;
  min-width: 80px;
}
.score-name {
  font-size: 0.75rem;
  opacity: 0.8;
  white-space: nowrap;
}
.score-value {
  font-family: 'Playfair Display', serif;
  font-size: 1.1rem;
  font-weight: 700;
}
.score-value.negative { color: var(--incorrect); }
.score-item.controlling { border-bottom: 3px solid var(--gold); }

/* Round indicator */
.round-indicator {
  text-align: center;
  padding: 6px;
  font-size: 0.8rem;
  color: var(--gold);
  background: rgba(0,0,0,0.3);
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
}

/* Board */
.board-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 8px;
  max-width: 900px;
  margin: 0 auto;
  width: 100%;
}

.board {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  grid-template-rows: auto repeat(5, 1fr);
  gap: 4px;
  flex: 1;
}

.board-category {
  background: var(--board-blue);
  padding: 8px 4px;
  text-align: center;
  font-family: 'Playfair Display', serif;
  font-size: 0.7rem;
  font-weight: 900;
  color: var(--white);
  text-transform: uppercase;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  line-height: 1.2;
  min-height: 48px;
}

.board-cell {
  background: var(--board-blue);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Playfair Display', serif;
  font-size: 1.4rem;
  font-weight: 900;
  color: var(--gold);
  cursor: pointer;
  border-radius: 4px;
  transition: transform 0.1s, background 0.15s;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  min-height: 56px;
  user-select: none;
}
.board-cell:hover:not(.used):not(.disabled) {
  background: #1010FF;
  transform: scale(1.03);
}
.board-cell.used {
  background: #0a0a4a;
  color: transparent;
  cursor: default;
}
.board-cell.disabled {
  cursor: default;
  opacity: 0.7;
}

/* ─── Clue Overlay ───────────────────────────────────────────── */
.clue-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: var(--board-blue);
  z-index: 100;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px;
}
.clue-overlay.active { display: flex; }

.clue-value-label {
  font-family: 'Playfair Display', serif;
  font-size: 1.5rem;
  color: var(--gold);
  margin-bottom: 16px;
}

.daily-double-splash {
  display: none;
  font-family: 'Playfair Display', serif;
  font-size: 3rem;
  color: var(--gold);
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  animation: ddPulse 0.6s ease-in-out;
}
.daily-double-splash.active { display: block; }

@keyframes ddPulse {
  0% { transform: scale(0.5); opacity: 0; }
  60% { transform: scale(1.1); opacity: 1; }
  100% { transform: scale(1); }
}

.clue-text {
  font-size: 1.6rem;
  text-align: center;
  max-width: 700px;
  line-height: 1.5;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
}

.clue-category-label {
  font-size: 0.85rem;
  color: rgba(255,255,255,0.6);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Buzzer */
.buzz-btn {
  margin-top: 32px;
  width: 180px;
  height: 180px;
  border-radius: 50%;
  border: 4px solid var(--gold);
  background: radial-gradient(circle, #ff4444, #cc0000);
  color: var(--white);
  font-size: 1.2rem;
  font-weight: 900;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 2px;
  box-shadow: 0 0 30px rgba(255,0,0,0.3);
  transition: transform 0.1s;
  display: none;
}
.buzz-btn.active {
  display: block;
  animation: buzzPulse 1s ease-in-out infinite;
}
.buzz-btn:active { transform: scale(0.9); }

@keyframes buzzPulse {
  0%, 100% { box-shadow: 0 0 20px rgba(255,0,0,0.3); }
  50% { box-shadow: 0 0 40px rgba(255,0,0,0.6); }
}

/* Answer input */
.answer-area {
  display: none;
  flex-direction: column;
  align-items: center;
  margin-top: 24px;
  width: 100%;
  max-width: 500px;
}
.answer-area.active { display: flex; }

.answering-label {
  font-size: 0.9rem;
  margin-bottom: 8px;
  color: var(--gold);
}

.answer-input {
  width: 100%;
  padding: 14px 18px;
  border: 2px solid var(--gold);
  border-radius: 8px;
  background: rgba(255,255,255,0.1);
  color: var(--white);
  font-size: 1.2rem;
  text-align: center;
  outline: none;
}
.answer-input:focus { border-color: #fff; }

.answer-timer {
  margin-top: 8px;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--gold);
}

.answer-submit-btn {
  margin-top: 12px;
  padding: 12px 40px;
  border: none;
  border-radius: 8px;
  background: var(--gold);
  color: #1a1a2e;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
}

/* Result display */
.result-display {
  display: none;
  flex-direction: column;
  align-items: center;
  margin-top: 24px;
  gap: 8px;
}
.result-display.active { display: flex; }

.result-label {
  font-size: 1.5rem;
  font-weight: 900;
}
.result-label.correct { color: var(--correct); }
.result-label.incorrect { color: var(--incorrect); }

.result-answer {
  font-size: 1.1rem;
  color: rgba(255,255,255,0.7);
}
.result-score-change {
  font-size: 1.2rem;
  font-weight: 700;
}

/* Wager input (DD + FJ) */
.wager-area {
  display: none;
  flex-direction: column;
  align-items: center;
  margin-top: 24px;
  width: 100%;
  max-width: 400px;
}
.wager-area.active { display: flex; }

.wager-label {
  font-size: 1rem;
  margin-bottom: 8px;
}
.wager-input {
  width: 100%;
  padding: 14px;
  border: 2px solid var(--gold);
  border-radius: 8px;
  background: rgba(255,255,255,0.1);
  color: var(--white);
  font-size: 1.5rem;
  text-align: center;
  outline: none;
}
.wager-submit-btn {
  margin-top: 12px;
  padding: 12px 40px;
  border: none;
  border-radius: 8px;
  background: var(--gold);
  color: #1a1a2e;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
}

/* ─── Final Jeopardy ─────────────────────────────────────────── */
.fj-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: var(--board-blue);
  z-index: 100;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px;
}
.fj-overlay.active { display: flex; }

.fj-title {
  font-family: 'Playfair Display', serif;
  font-size: 2rem;
  color: var(--gold);
  margin-bottom: 24px;
}
.fj-category {
  font-family: 'Playfair Display', serif;
  font-size: 1.8rem;
  text-transform: uppercase;
  margin-bottom: 16px;
}
.fj-clue {
  font-size: 1.5rem;
  text-align: center;
  max-width: 700px;
  line-height: 1.5;
  margin-bottom: 24px;
}
.fj-waiting {
  color: rgba(255,255,255,0.5);
  font-size: 0.9rem;
}

/* FJ reveal */
.fj-reveal-card {
  background: rgba(0,0,0,0.3);
  border-radius: 12px;
  padding: 20px 32px;
  margin: 8px 0;
  min-width: 300px;
  text-align: center;
  animation: revealSlide 0.5s ease-out;
}
@keyframes revealSlide {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.fj-reveal-name { font-size: 1.1rem; font-weight: 700; }
.fj-reveal-answer { font-size: 0.9rem; color: rgba(255,255,255,0.6); margin: 4px 0; }
.fj-reveal-wager { font-size: 0.9rem; }
.fj-reveal-score { font-size: 1.3rem; font-weight: 900; margin-top: 4px; }

/* ─── Game Over ──────────────────────────────────────────────── */
.gameover-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  z-index: 200;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px;
}
.gameover-overlay.active { display: flex; }

.gameover-title {
  font-family: 'Playfair Display', serif;
  font-size: 2.5rem;
  color: var(--gold);
  margin-bottom: 24px;
}
.standings-list {
  list-style: none;
  width: 100%;
  max-width: 400px;
}
.standings-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  margin-bottom: 8px;
}
.standings-item:first-child {
  background: rgba(215,163,42,0.2);
  border: 2px solid var(--gold);
}
.standings-rank {
  font-weight: 900;
  width: 30px;
  color: var(--gold);
}
.standings-name { flex: 1; }
.standings-score {
  font-family: 'Playfair Display', serif;
  font-size: 1.2rem;
  font-weight: 700;
}

.play-again-btn {
  margin-top: 24px;
  padding: 14px 40px;
  border: 2px solid var(--gold);
  border-radius: 8px;
  background: transparent;
  color: var(--gold);
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
}

/* Status bar */
.status-bar {
  padding: 8px 16px;
  text-align: center;
  font-size: 0.85rem;
  color: rgba(255,255,255,0.7);
  background: rgba(0,0,0,0.3);
}

/* Home link */
.home-link {
  position: fixed;
  top: 12px;
  left: 12px;
  z-index: 50;
  color: rgba(255,255,255,0.5);
  text-decoration: none;
  font-size: 0.8rem;
  padding: 6px 12px;
  border-radius: 6px;
  background: rgba(0,0,0,0.3);
  transition: color 0.2s;
}
.home-link:hover { color: var(--white); }

/* Global timer bar pinned to bottom of clue overlay */
.clue-timer-bar {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 6px;
  background: var(--gold);
  transition: width 0.1s linear;
  width: 0%;
}

/* Timer bar (FJ) */
.timer-bar {
  height: 4px;
  background: var(--gold);
  transition: width 0.1s linear;
  border-radius: 2px;
  margin-top: 16px;
  width: 100%;
}

/* Responsive */
/* ─── Episode Picker Modal ────────────────────────────────── */
.ep-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 300;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.ep-modal.active { display: flex; }

.ep-modal-content {
  background: #0a0a3a;
  border-radius: 16px;
  width: 100%;
  max-width: 500px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.ep-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  background: rgba(0,0,0,0.3);
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.ep-title {
  font-weight: 700;
  font-size: 1rem;
}
.ep-back, .ep-close {
  background: none;
  border: none;
  color: var(--gold);
  font-size: 0.9rem;
  font-weight: 700;
  cursor: pointer;
  padding: 4px 8px;
}

.ep-body {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
}

.ep-row {
  display: flex;
  align-items: center;
  padding: 12px 14px;
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: background 0.15s;
  gap: 12px;
}
.ep-row:hover { background: rgba(255,255,255,0.1); }
.ep-row.selected { background: rgba(215,163,42,0.2); border: 2px solid var(--gold); }

.ep-row-info {
  flex: 1;
  min-width: 0;
}
.ep-row-title {
  font-weight: 700;
  color: var(--gold);
  font-size: 0.95rem;
}
.ep-row-sub {
  font-size: 0.8rem;
  color: rgba(255,255,255,0.5);
  margin-top: 2px;
}
.ep-row-badges {
  display: flex;
  gap: 8px;
  margin-top: 4px;
}
.ep-badge {
  font-size: 0.7rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 3px;
}
.ep-badge.completed { color: #4CAF50; }
.ep-badge.in-progress { color: #FFC107; }

.ep-row-arrow {
  color: rgba(255,255,255,0.3);
  font-size: 1.1rem;
}

.ep-row-status {
  font-size: 0.85rem;
  flex-shrink: 0;
}

/* Progress bar for individual games */
.ep-progress {
  height: 3px;
  background: rgba(255,255,255,0.1);
  border-radius: 2px;
  margin-top: 4px;
  overflow: hidden;
}
.ep-progress-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.3s;
}

/* ─── Mode Selector (side by side) ───────────────────────── */
.mode-selector {
  display: flex;
  gap: 16px;
  width: 100%;
  max-width: 620px;
}
.mode-card {
  flex: 1;
  background: rgba(255,255,255,0.08);
  border-radius: 16px;
  padding: 28px 24px;
  backdrop-filter: blur(10px);
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  cursor: pointer;
  border: 2px solid transparent;
  transition: border-color 0.2s, background 0.2s, transform 0.1s;
}
.mode-card:hover {
  background: rgba(255,255,255,0.12);
  transform: translateY(-2px);
}
.mode-card:active { transform: scale(0.98); }
.mode-card .mode-icon { font-size: 2.2rem; margin-bottom: 12px; }
.mode-card .mode-label {
  font-family: 'Playfair Display', serif;
  font-size: 1.15rem;
  font-weight: 900;
  color: var(--gold);
  margin-bottom: 6px;
}
.mode-card .mode-desc {
  font-size: 0.8rem;
  color: rgba(255,255,255,0.5);
  line-height: 1.4;
}

/* ─── Intro Animation ─────────────────────────────────────── */
.intro-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: #0a0a3a;
  z-index: 250;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}
.intro-overlay.active { display: flex; }

.intro-overlay::before {
  content: '';
  position: absolute;
  inset: -50%;
  background: radial-gradient(circle at 50% 50%, rgba(6,12,233,0.3) 0%, transparent 60%);
  animation: intro-glow 3s ease-in-out infinite;
}
@keyframes intro-glow {
  0%, 100% { opacity: 0.5; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.1); }
}

.intro-title {
  font-family: 'Playfair Display', serif;
  font-size: 1rem;
  color: rgba(255,255,255,0.7);
  text-transform: uppercase;
  letter-spacing: 6px;
  opacity: 0;
  transform: translateY(20px);
  z-index: 1;
}
.intro-title.animate {
  animation: intro-fade-in 0.8s ease-out forwards;
}

.intro-main-title {
  font-family: 'Playfair Display', serif;
  font-size: 4rem;
  font-weight: 900;
  color: var(--gold);
  text-shadow: 0 0 40px rgba(215,163,42,0.5), 2px 2px 4px rgba(0,0,0,0.5);
  opacity: 0;
  transform: scale(0.5);
  z-index: 1;
  margin: 12px 0 24px;
}
.intro-main-title.animate {
  animation: intro-title-pop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

@keyframes intro-fade-in {
  to { opacity: 1; transform: translateY(0); }
}
@keyframes intro-title-pop {
  to { opacity: 1; transform: scale(1); }
}

.intro-categories {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  z-index: 1;
}
.intro-cat-item {
  font-family: 'Playfair Display', serif;
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--white);
  text-transform: uppercase;
  letter-spacing: 1px;
  opacity: 0;
  transform: translateX(-30px);
}
.intro-cat-item.animate {
  animation: intro-cat-slide 0.4s ease-out forwards;
}
@keyframes intro-cat-slide {
  to { opacity: 1; transform: translateX(0); }
}

.intro-round-label {
  font-family: 'Playfair Display', serif;
  font-size: 1.5rem;
  font-weight: 900;
  color: var(--gold);
  opacity: 0;
  z-index: 1;
  margin-bottom: 16px;
}
.intro-round-label.animate {
  animation: intro-fade-in 0.5s ease-out forwards;
}

@media (max-width: 600px) {
  .board-category { font-size: 0.55rem; padding: 4px 2px; min-height: 40px; }
  .board-cell { font-size: 1rem; min-height: 44px; }
  .clue-text { font-size: 1.2rem; }
  .buzz-btn { width: 140px; height: 140px; font-size: 1rem; }
  .lobby-title { font-size: 2rem; }
  .mode-selector { flex-direction: column; gap: 10px; }
  .mode-card { padding: 20px 18px; }
  .mode-card .mode-icon { font-size: 1.6rem; margin-bottom: 8px; }
  .intro-main-title { font-size: 2.5rem; }
}
</style>
</head>
<body>

<a class="home-link" href="/">&#8592; Home</a>
<button id="mute-btn" style="position:fixed; top:12px; right:12px; z-index:50; background:rgba(0,0,0,0.3); border:none; color:rgba(255,255,255,0.5); font-size:1.2rem; padding:6px 10px; border-radius:6px; cursor:pointer;" onclick="toggleMute()">&#128264;</button>

<!-- ─── Lobby ───────────────────────────────────────────────── -->
<div id="lobby">
  <div class="lobby-title">JEOPARDY!</div>
  <div class="lobby-subtitle">Trivia</div>

  <!-- Step 1: Single Player / Multiplayer -->
  <div id="lobby-choice" class="mode-selector">
    <div class="mode-card" id="btn-choice-single">
      <div class="mode-icon">&#9733;</div>
      <div class="mode-label">Single Player</div>
      <div class="mode-desc">Play against CPU opponents</div>
    </div>
    <div class="mode-card" id="btn-choice-multi">
      <div class="mode-icon">&#9775;</div>
      <div class="mode-label">Multiplayer</div>
      <div class="mode-desc">Host or join a game with friends</div>
    </div>
  </div>

  <!-- Step 1b: Multiplayer — host or join -->
  <div id="lobby-multi-choice" class="lobby-card" style="display:none;">
    <button class="lobby-btn btn-gold" id="btn-choice-host">Host Game</button>
    <div class="lobby-or">- or -</div>
    <button class="lobby-btn btn-blue" id="btn-choice-join">Join Game</button>
  </div>

  <!-- Step 2s: Single player — enter name -->
  <div id="lobby-single-name" class="lobby-card" style="display:none;">
    <h2>Your Name</h2>
    <input class="lobby-input" id="single-name" placeholder="Your name" maxlength="20" autocomplete="off">
    <button class="lobby-btn btn-gold" id="btn-single-go">Play</button>
  </div>

  <!-- Step 2a: Host — enter name -->
  <div id="lobby-host-name" class="lobby-card" style="display:none;">
    <h2>Your Name</h2>
    <input class="lobby-input" id="host-name" placeholder="Your name" maxlength="20" autocomplete="off">
    <button class="lobby-btn btn-gold" id="btn-host-go">Create Room</button>
  </div>

  <!-- Step 2b: Join — enter name + room code -->
  <div id="lobby-join-form" class="lobby-card" style="display:none;">
    <h2>Join a Room</h2>
    <input class="lobby-input" id="join-name" placeholder="Your name" maxlength="20" autocomplete="off">
    <input class="lobby-input" id="room-code-input" placeholder="Room code" maxlength="4" style="text-transform:uppercase; letter-spacing:4px; text-align:center;" autocomplete="off">
    <button class="lobby-btn btn-gold" id="btn-join-go">Join</button>
  </div>

  <!-- Step 3: In-room waiting -->
  <div id="lobby-room" class="lobby-card" style="display:none;">
    <div id="room-code-section">
      <h2>Room</h2>
      <div class="room-code-display" id="room-code"></div>
      <div style="font-size:0.8rem; color:#888; margin-bottom:12px;">Share this code with friends</div>
    </div>
    <h2 id="single-player-heading" style="display:none;">Single Player</h2>
    <ul class="player-list" id="player-list"></ul>

    <!-- Add CPU (host only) -->
    <div id="cpu-controls" style="display:none; margin-top:8px;">
      <div style="display:flex; gap:6px; flex-wrap:wrap;">
        <button class="lobby-btn btn-outline" style="flex:1; padding:8px; font-size:0.8rem;" onclick="addCPU('easy')">+ CPU Easy</button>
        <button class="lobby-btn btn-outline" style="flex:1; padding:8px; font-size:0.8rem;" onclick="addCPU('medium')">+ CPU Med</button>
        <button class="lobby-btn btn-outline" style="flex:1; padding:8px; font-size:0.8rem;" onclick="addCPU('hard')">+ CPU Hard</button>
      </div>
    </div>

    <div class="game-info" id="game-info"></div>

    <!-- Episode picker (host only) -->
    <div id="episode-picker" style="display:none; margin-top:16px;">
      <button class="lobby-btn btn-outline" id="btn-pick-episode" style="text-align:left; padding:12px 16px;">
        <span id="pick-episode-label">Pick an Episode</span>
      </button>
      <button class="lobby-btn btn-outline" id="btn-random-game" style="margin-top:6px; padding:10px;">Random Episode</button>
    </div>

    <button class="lobby-btn btn-gold" id="btn-start" style="display:none; margin-top:16px;">Start Game</button>
  </div>
</div>

<!-- ─── Game ─────────────────────────────────────────────────── -->
<div id="game">
  <div class="scores-bar" id="scores-bar"></div>
  <div class="round-indicator" id="round-indicator">Jeopardy!</div>
  <div class="board-container">
    <div class="board" id="board"></div>
  </div>
  <div class="status-bar" id="status-bar"></div>
</div>

<!-- ─── Clue Overlay ─────────────────────────────────────────── -->
<div class="clue-overlay" id="clue-overlay">
  <div class="daily-double-splash" id="dd-splash">DAILY DOUBLE!</div>
  <div class="clue-category-label" id="clue-cat-label"></div>
  <div class="clue-value-label" id="clue-value-label"></div>
  <div class="clue-text" id="clue-text"></div>

  <!-- Wager (DD) -->
  <div class="wager-area" id="dd-wager-area">
    <div class="wager-label">How much will you wager?</div>
    <input class="wager-input" id="dd-wager-input" type="number" min="5" placeholder="$" autocomplete="off">
    <button class="wager-submit-btn" id="dd-wager-btn">Wager</button>
  </div>

  <!-- Buzzer -->
  <button class="buzz-btn" id="buzz-btn">BUZZ IN</button>

  <!-- Answer input -->
  <div class="answer-area" id="answer-area">
    <div class="answering-label" id="answering-label"></div>
    <input class="answer-input" id="answer-input" placeholder="What is..." autocomplete="off">
    <button class="answer-submit-btn" id="answer-submit-btn">Submit</button>
    <div class="answer-timer" id="answer-timer"></div>
  </div>

  <!-- Result -->
  <div class="result-display" id="result-display">
    <div class="result-label" id="result-label"></div>
    <div class="result-answer" id="result-answer"></div>
    <div class="result-score-change" id="result-score-change"></div>
  </div>

  <!-- Global timer bar pinned to bottom of clue overlay -->
  <div class="clue-timer-bar" id="clue-timer-bar"></div>
</div>

<!-- ─── Final Jeopardy Overlay ───────────────────────────────── -->
<div class="fj-overlay" id="fj-overlay">
  <div class="fj-title">Final Jeopardy!</div>
  <div class="fj-category" id="fj-category"></div>
  <div class="fj-clue" id="fj-clue"></div>

  <!-- FJ Wager -->
  <div class="wager-area" id="fj-wager-area">
    <div class="wager-label">Your wager (up to your score):</div>
    <input class="wager-input" id="fj-wager-input" type="number" min="0" placeholder="$" autocomplete="off">
    <button class="wager-submit-btn" id="fj-wager-btn">Lock In Wager</button>
  </div>

  <!-- FJ Answer -->
  <div class="answer-area" id="fj-answer-area">
    <input class="answer-input" id="fj-answer-input" placeholder="What is..." autocomplete="off">
    <button class="answer-submit-btn" id="fj-answer-btn">Submit Answer</button>
    <div class="answer-timer" id="fj-timer">30</div>
    <div class="timer-bar" id="fj-timer-bar"></div>
  </div>

  <div class="fj-waiting" id="fj-waiting"></div>

  <!-- FJ Reveals -->
  <div id="fj-reveals"></div>
</div>

<!-- ─── Episode Picker Modal ──────────────────────────────────── -->
<div class="ep-modal" id="ep-modal">
  <div class="ep-modal-content">
    <div class="ep-header">
      <button class="ep-back" id="ep-back" style="visibility:hidden;">&#8592; Seasons</button>
      <span class="ep-title" id="ep-title">Select Episode</span>
      <button class="ep-close" id="ep-close">Done</button>
    </div>
    <div class="ep-body" id="ep-body">
      <!-- Season list or game list rendered here -->
    </div>
  </div>
</div>

<!-- ─── Intro Animation Overlay ──────────────────────────────── -->
<div class="intro-overlay" id="intro-overlay">
  <div class="intro-title" id="intro-subtitle">THIS IS</div>
  <div class="intro-main-title" id="intro-main-title">JEOPARDY!</div>
  <div class="intro-round-label" id="intro-round-label"></div>
  <div class="intro-categories" id="intro-categories"></div>
</div>

<!-- ─── Game Over Overlay ────────────────────────────────────── -->
<div class="gameover-overlay" id="gameover-overlay">
  <div class="gameover-title">Game Over!</div>
  <ul class="standings-list" id="standings-list"></ul>
  <button class="play-again-btn" id="btn-play-again">Play Again</button>
  <a class="play-again-btn" href="/" style="display:inline-block; text-decoration:none; margin-top:8px; text-align:center;">Back to Home</a>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
(function() {
  // ─── State ──────────────────────────────────────────────────
  let socket;
  let mySocketId;
  let roomId = null;
  let isHost = false;
  let isSinglePlayer = false;
  let gameState = null; // full room-state from server
  let answerTimerInterval = null;
  let fjTimerInterval = null;
  let hasBuzzedThisClue = false;
  let lastAnnouncedRound = null;

  // ─── Sound system ──────────────────────────────────────────
  const sfx = {};
  let isMuted = localStorage.getItem('jeopardy-muted') === 'true';

  ['buzz','correct','incorrect','intro','select','think','tick','timesup'].forEach(n => {
    sfx[n] = new Audio(`/audio/${n}.mp3`);
    sfx[n].preload = 'auto';
  });

  function playSound(name) {
    if (isMuted || !sfx[name]) return;
    const s = sfx[name].cloneNode();
    s.play().catch(() => {});
  }
  function playLoop(name) {
    if (isMuted || !sfx[name]) return;
    sfx[name].loop = true;
    sfx[name].currentTime = 0;
    sfx[name].play().catch(() => {});
  }
  function stopLoop(name) {
    if (!sfx[name]) return;
    sfx[name].loop = false;
    sfx[name].pause();
    sfx[name].currentTime = 0;
  }

  // TTS host voice
  function hostSay(text, onEnd) {
    if (isMuted || !window.speechSynthesis) { if (onEnd) setTimeout(onEnd, 100); return; }
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-US';
    u.rate = 0.9;
    if (onEnd) u.onend = onEnd;
    speechSynthesis.speak(u);
  }

  function hostSaySequence(texts, cb) {
    let i = 0;
    (function next() {
      if (i >= texts.length) { if (cb) cb(); return; }
      hostSay(texts[i++], next);
    })();
  }

  window.toggleMute = function() {
    isMuted = !isMuted;
    localStorage.setItem('jeopardy-muted', isMuted);
    document.getElementById('mute-btn').innerHTML = isMuted ? '&#128263;' : '&#128264;';
    if (isMuted) {
      speechSynthesis.cancel();
      Object.values(sfx).forEach(s => { s.pause(); s.currentTime = 0; s.loop = false; });
    }
  };
  // Set initial mute icon
  if (isMuted) document.getElementById('mute-btn').innerHTML = '&#128263;';

  // Device ID for user identity
  function getDeviceId() {
    let id = localStorage.getItem('jeopardy-device-id');
    if (!id) { id = crypto.randomUUID(); localStorage.setItem('jeopardy-device-id', id); }
    return id;
  }

  // ─── DOM refs ───────────────────────────────────────────────
  const $lobby = document.getElementById('lobby');
  const $lobbyChoice = document.getElementById('lobby-choice');
  const $lobbyMultiChoice = document.getElementById('lobby-multi-choice');
  const $lobbySingleName = document.getElementById('lobby-single-name');
  const $lobbyHostName = document.getElementById('lobby-host-name');
  const $lobbyJoinForm = document.getElementById('lobby-join-form');
  const $lobbyRoom = document.getElementById('lobby-room');
  const $game = document.getElementById('game');
  const $board = document.getElementById('board');
  const $scoresBar = document.getElementById('scores-bar');
  const $roundIndicator = document.getElementById('round-indicator');
  const $statusBar = document.getElementById('status-bar');
  const $clueOverlay = document.getElementById('clue-overlay');
  const $fjOverlay = document.getElementById('fj-overlay');
  const $gameoverOverlay = document.getElementById('gameover-overlay');

  // ─── Connect ────────────────────────────────────────────────
  function connect() {
    socket = io('/jeopardy', { transports: ['websocket', 'polling'] });
    socket.on('connect', () => { mySocketId = socket.id; });

    socket.on('room-state', onRoomState);
    socket.on('player-joined', onPlayerJoined);
    socket.on('player-left', onPlayerLeft);
    socket.on('phase-change', onPhaseChange);
    socket.on('round-change', onRoundChange);
    socket.on('clue-selected', onClueSelected);
    socket.on('daily-double', onDailyDouble);
    socket.on('buzzer-result', onBuzzerResult);
    socket.on('buzzer-expired', onBuzzerExpired);
    socket.on('answer-result', onAnswerResult);
    socket.on('scores-update', onScoresUpdate);
    socket.on('final-category', onFinalCategory);
    socket.on('final-clue', onFinalClue);
    socket.on('final-wager-submitted', onFinalWagerSubmitted);
    socket.on('final-answer-submitted', onFinalAnswerSubmitted);
    socket.on('final-jeopardy-reveal', onFinalReveal);
    socket.on('game-over', onGameOver);
  }

  connect();

  // Ensure clean URL on load
  if (window.location.pathname !== '/jeopardy') {
    history.replaceState(null, '', '/jeopardy');
  }

  function hideAllLobbyCards() {
    $lobbyChoice.style.display = 'none';
    $lobbyMultiChoice.style.display = 'none';
    $lobbySingleName.style.display = 'none';
    $lobbyHostName.style.display = 'none';
    $lobbyJoinForm.style.display = 'none';
    $lobbyRoom.style.display = 'none';
  }

  // ─── Lobby handlers ────────────────────────────────────────

  // Step 1: Single Player or Multiplayer
  document.getElementById('btn-choice-single').onclick = () => {
    hideAllLobbyCards();
    $lobbySingleName.style.display = 'block';
    document.getElementById('single-name').focus();
  };

  document.getElementById('btn-choice-multi').onclick = () => {
    hideAllLobbyCards();
    $lobbyMultiChoice.style.display = 'block';
  };

  // Step 1b: Host or Join
  document.getElementById('btn-choice-host').onclick = () => {
    hideAllLobbyCards();
    $lobbyHostName.style.display = 'block';
    document.getElementById('host-name').focus();
  };

  document.getElementById('btn-choice-join').onclick = () => {
    hideAllLobbyCards();
    $lobbyJoinForm.style.display = 'block';
    document.getElementById('join-name').focus();
  };

  // Single player: create room + auto-add a medium CPU
  document.getElementById('btn-single-go').onclick = () => {
    const name = document.getElementById('single-name').value.trim() || 'Player';
    socket.emit('create-room', { playerName: name, deviceId: getDeviceId() }, (res) => {
      if (res.error) { alert(res.error); return; }
      roomId = res.roomId;
      isHost = true;
      isSinglePlayer = true;
      socket.emit('add-cpu', { difficulty: 'medium' });
      showRoom();
    });
  };
  document.getElementById('single-name').onkeydown = (e) => {
    if (e.key === 'Enter') document.getElementById('btn-single-go').click();
  };

  // Step 2a: Host enters name → create room
  document.getElementById('btn-host-go').onclick = () => {
    const name = document.getElementById('host-name').value.trim() || 'Player';
    socket.emit('create-room', { playerName: name, deviceId: getDeviceId() }, (res) => {
      if (res.error) { alert(res.error); return; }
      roomId = res.roomId;
      isHost = true;
      isSinglePlayer = false;
      showRoom();
    });
  };
  document.getElementById('host-name').onkeydown = (e) => {
    if (e.key === 'Enter') document.getElementById('btn-host-go').click();
  };

  // Step 2b: Joiner enters name + room code → join room
  document.getElementById('btn-join-go').onclick = () => {
    const name = document.getElementById('join-name').value.trim() || 'Player';
    const code = document.getElementById('room-code-input').value.trim().toUpperCase();
    if (!code || code.length !== 4) { alert('Enter a 4-letter room code'); return; }
    socket.emit('join-room', { roomId: code, playerName: name, deviceId: getDeviceId() }, (res) => {
      if (res.error) { alert(res.error); return; }
      roomId = res.roomId;
      isHost = false;
      showRoom();
    });
  };
  document.getElementById('join-name').onkeydown = (e) => {
    if (e.key === 'Enter') document.getElementById('room-code-input').focus();
  };
  document.getElementById('room-code-input').onkeydown = (e) => {
    if (e.key === 'Enter') document.getElementById('btn-join-go').click();
  };

  document.getElementById('btn-start').onclick = () => {
    socket.emit('start-game');
  };

  function showRoom() {
    hideAllLobbyCards();
    $lobbyRoom.style.display = 'block';

    if (isSinglePlayer) {
      document.getElementById('room-code-section').style.display = 'none';
      document.getElementById('single-player-heading').style.display = 'block';
    } else {
      document.getElementById('room-code-section').style.display = 'block';
      document.getElementById('single-player-heading').style.display = 'none';
      document.getElementById('room-code').textContent = roomId;
    }

    // Show episode picker and CPU controls for host
    if (isHost) {
      document.getElementById('episode-picker').style.display = 'block';
      document.getElementById('cpu-controls').style.display = 'block';
    }
  }

  // ─── Episode picker modal ──────────────────────────────────
  const $epModal = document.getElementById('ep-modal');
  const $epBody = document.getElementById('ep-body');
  const $epTitle = document.getElementById('ep-title');
  const $epBack = document.getElementById('ep-back');
  let epSeasonsCache = null;

  document.getElementById('btn-pick-episode').onclick = () => {
    $epModal.classList.add('active');
    showSeasonList();
  };
  document.getElementById('ep-close').onclick = () => {
    $epModal.classList.remove('active');
  };
  document.getElementById('ep-back').onclick = () => {
    showSeasonList();
  };

  document.getElementById('btn-random-game').onclick = () => {
    socket.emit('random-game');
  };

  async function showSeasonList() {
    $epTitle.textContent = 'Select Episode';
    $epBack.style.visibility = 'hidden';
    $epBody.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">Loading...</div>';

    try {
      const res = await fetch('/api/jeopardy/seasons');
      const seasons = await res.json();
      epSeasonsCache = seasons;
      $epBody.innerHTML = '';

      // Show newest seasons first
      for (const s of [...seasons].reverse()) {
        const row = document.createElement('div');
        row.className = 'ep-row';
        let badges = '';
        if (s.completed_count > 0) {
          badges += `<span class="ep-badge completed">&#10003; ${s.completed_count}</span>`;
        }
        if (s.in_progress_count > 0) {
          badges += `<span class="ep-badge in-progress">&#9998; ${s.in_progress_count}</span>`;
        }
        row.innerHTML = `
          <div class="ep-row-info">
            <div class="ep-row-title">Season ${s.season}</div>
            <div class="ep-row-sub">${s.game_count} games &middot; ${s.first_date || ''} to ${s.last_date || ''}</div>
            ${badges ? `<div class="ep-row-badges">${badges}</div>` : ''}
          </div>
          <span class="ep-row-arrow">&#8250;</span>
        `;
        row.onclick = () => showGameList(s.season);
        $epBody.appendChild(row);
      }
    } catch (e) {
      $epBody.innerHTML = '<div style="text-align:center; padding:20px; color:#f44;">Failed to load seasons</div>';
    }
  }

  async function showGameList(season) {
    $epTitle.textContent = `Season ${season}`;
    $epBack.style.visibility = 'visible';
    $epBody.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">Loading...</div>';

    try {
      const res = await fetch(`/api/jeopardy/seasons/${season}`);
      const games = await res.json();
      $epBody.innerHTML = '';

      for (const g of games) {
        const row = document.createElement('div');
        const isSelected = gameState && gameState.gameId === g.game_id;
        row.className = 'ep-row' + (isSelected ? ' selected' : '');

        let status = '';
        let progressBar = '';
        if (g.completed) {
          status = '<span class="ep-badge completed" style="font-size:0.85rem;">&#10003; Completed</span>';
        } else if (g.clues_answered > 0) {
          const pct = Math.round((g.clues_answered / (g.total_clues || 60)) * 100);
          status = `<span class="ep-badge in-progress" style="font-size:0.85rem;">In Progress</span>`;
          progressBar = `<div class="ep-progress"><div class="ep-progress-fill" style="width:${pct}%; background:var(--gold);"></div></div>`;
        }

        row.innerHTML = `
          <div class="ep-row-info">
            <div class="ep-row-title">Show #${g.show_number} <span style="font-weight:400; color:rgba(255,255,255,0.5); font-size:0.8rem;">${g.air_date}</span></div>
            ${status}
            ${progressBar}
          </div>
          <span class="ep-row-arrow">&#8250;</span>
        `;
        row.onclick = () => {
          socket.emit('change-game', { gameId: g.game_id });
          document.getElementById('pick-episode-label').textContent = `Show #${g.show_number} — ${g.air_date}`;
          $epModal.classList.remove('active');
        };
        $epBody.appendChild(row);
      }
    } catch (e) {
      $epBody.innerHTML = '<div style="text-align:center; padding:20px; color:#f44;">Failed to load games</div>';
    }
  }

  // ─── Room state handler ─────────────────────────────────────
  function onRoomState(state) {
    gameState = state;

    // Update player list in lobby
    const $list = document.getElementById('player-list');
    $list.innerHTML = '';
    for (const p of state.players) {
      const li = document.createElement('li');
      let badges = '';
      if (p.isHost) badges += '<span class="player-host">HOST</span>';
      if (p.isAI) {
        const diffLabel = p.difficulty ? p.difficulty.charAt(0).toUpperCase() + p.difficulty.slice(1) : 'CPU';
        badges += `<span class="player-host" style="background:#9C27B0;">CPU - ${esc(diffLabel)}</span>`;
      }
      let removeBtn = '';
      if (p.isAI && isHost && state.phase === 'lobby') {
        removeBtn = `<button onclick="removeCPU('${p.socketId}')" style="background:none; border:none; color:#F44336; cursor:pointer; font-size:1.1rem; margin-left:4px;" title="Remove">&times;</button>`;
      }
      li.innerHTML = `<span class="player-dot" style="background:${p.color}"></span>
        <span>${esc(p.name)}</span>
        ${badges}${removeBtn}`;
      $list.appendChild(li);
    }

    // Show/hide CPU controls based on player count and host status
    const cpuCtrl = document.getElementById('cpu-controls');
    if (isHost && state.phase === 'lobby' && state.players.length < 4) {
      cpuCtrl.style.display = 'block';
    } else {
      cpuCtrl.style.display = 'none';
    }

    // Show start button for host in lobby
    const btnStart = document.getElementById('btn-start');
    const meHost = state.players.find(p => p.socketId === mySocketId && p.isHost);
    btnStart.style.display = (state.phase === 'lobby' && meHost) ? 'block' : 'none';

    // Game info
    const $info = document.getElementById('game-info');
    if (state.showNumber) {
      $info.textContent = `Show #${state.showNumber} — ${state.airDate || ''}`;
      document.getElementById('pick-episode-label').textContent = `Show #${state.showNumber} — ${state.airDate || ''}`;
    }

    if (state.phase === 'lobby') {
      $lobby.style.display = 'flex';
      $game.classList.remove('active');
      return;
    }

    // In-game — set URL to include room code
    $lobby.style.display = 'none';
    $game.classList.add('active');
    if (roomId && window.location.pathname !== `/jeopardy/${roomId}`) {
      history.replaceState(null, '', `/jeopardy/${roomId}`);
    }

    renderScores(state.players, state.controllingPlayer);
    renderRoundIndicator(state.currentRound);
    renderBoard(state);
    renderStatusBar(state);

    // Handle overlays based on phase
    if (['readingClue','buzzerOpen','playerAnswering','showingResult','dailyDoubleWager','dailyDoubleAnswer'].includes(state.phase)) {
      // clue overlay is managed by specific events
    } else if (['finalCategory','finalWager','finalClue','finalResults'].includes(state.phase)) {
      // FJ overlay managed by events
    } else {
      $clueOverlay.classList.remove('active');
    }
  }

  function onPlayerJoined(data) {
    // Will get full state update
  }

  function onPlayerLeft(data) {
    // Will get full state update
  }

  function onPhaseChange({ phase }) {
    if (gameState) gameState.phase = phase;

    if (phase === 'buzzerOpen') {
      playSound('tick');
      // Only show buzzer if we haven't buzzed on this clue
      if (!hasBuzzedThisClue) {
        showBuzzer();
      } else {
        // Hide buzzer, just show clue while others can buzz
        document.getElementById('buzz-btn').classList.remove('active');
        document.getElementById('result-display').classList.remove('active');
        document.getElementById('answer-area').classList.remove('active');
      }
      startClueTimer(5); // 5s buzzer window
    } else if (phase === 'selectingClue') {
      $clueOverlay.classList.remove('active');
      clearAnswerTimer();
      stopClueTimer();
    }
  }

  function onRoundChange({ round }) {
    if (gameState) gameState.currentRound = round;
    renderRoundIndicator(round);

    if (round === 'finalJeopardy') {
      $clueOverlay.classList.remove('active');
    }

    // Announce round with intro animation + music + TTS
    if (lastAnnouncedRound !== round && round !== 'finalJeopardy') {
      lastAnnouncedRound = round;
      const roundLabel = round === 'jeopardy' ? 'Jeopardy!' : 'Double Jeopardy!';
      const cats = round === 'jeopardy'
        ? gameState?.gameData?.jRound?.categories
        : gameState?.gameData?.djRound?.categories;

      playIntroAnimation(roundLabel, cats || [], () => {
        const texts = [`Let's play ${roundLabel}`];
        if (cats && cats.length) {
          texts.push("Today's categories are");
          cats.forEach(c => texts.push(c));
        }
        hostSaySequence(texts);
      });
    }
  }

  function playIntroAnimation(roundLabel, categories, onComplete) {
    const $overlay = document.getElementById('intro-overlay');
    const $subtitle = document.getElementById('intro-subtitle');
    const $mainTitle = document.getElementById('intro-main-title');
    const $roundLabel = document.getElementById('intro-round-label');
    const $cats = document.getElementById('intro-categories');

    // Reset all elements
    $subtitle.className = 'intro-title';
    $mainTitle.className = 'intro-main-title';
    $roundLabel.className = 'intro-round-label';
    $roundLabel.textContent = roundLabel;
    $cats.innerHTML = '';

    // Show overlay
    $overlay.classList.add('active');
    playSound('intro');

    // Staggered animations
    let delay = 200;

    // "THIS IS"
    setTimeout(() => $subtitle.classList.add('animate'), delay);
    delay += 400;

    // "JEOPARDY!"
    setTimeout(() => $mainTitle.classList.add('animate'), delay);
    delay += 800;

    // Round label (e.g., "Double Jeopardy!")
    setTimeout(() => $roundLabel.classList.add('animate'), delay);
    delay += 600;

    // Categories one by one
    for (let i = 0; i < categories.length; i++) {
      const catEl = document.createElement('div');
      catEl.className = 'intro-cat-item';
      catEl.textContent = categories[i];
      $cats.appendChild(catEl);

      setTimeout(() => catEl.classList.add('animate'), delay);
      delay += 300;
    }

    // Hold for a moment then dismiss
    delay += 1000;
    setTimeout(() => {
      $overlay.classList.remove('active');
      if (onComplete) onComplete();
    }, delay);
  }

  // ─── Clue events ──────────────────────────────────────────
  function onClueSelected({ cat, row, value, clue, dailyDouble }) {
    $clueOverlay.classList.add('active');
    hasBuzzedThisClue = false;
    playSound('select');

    const $ddSplash = document.getElementById('dd-splash');
    const $clueText = document.getElementById('clue-text');
    const $clueCat = document.getElementById('clue-cat-label');
    const $clueVal = document.getElementById('clue-value-label');
    const $buzzBtn = document.getElementById('buzz-btn');
    const $answerArea = document.getElementById('answer-area');
    const $resultDisplay = document.getElementById('result-display');
    const $ddWagerArea = document.getElementById('dd-wager-area');

    $ddSplash.classList.remove('active');
    $buzzBtn.classList.remove('active');
    $answerArea.classList.remove('active');
    $resultDisplay.classList.remove('active');
    $ddWagerArea.classList.remove('active');

    const categories = gameState.currentRound === 'jeopardy'
      ? gameState.gameData.jRound.categories
      : gameState.gameData.djRound.categories;
    $clueCat.textContent = categories[cat] || '';
    $clueVal.textContent = `$${value}`;
    $clueText.textContent = clue;

    // TTS read the clue
    speechSynthesis.cancel();
    hostSay(clue);

    // Mark cell as used on board
    if (gameState) {
      const key = `${cat},${row}`;
      if (!gameState.usedClues.includes(key)) gameState.usedClues.push(key);
      renderBoard(gameState);
    }

    // Daily Double: show answer input for the answering player
    if (dailyDouble) {
      const amAnswerer = gameState && gameState.answeringPlayer === mySocketId;
      if (amAnswerer) {
        showAnswerInput(10);
      } else {
        const name = gameState?.answeringPlayerName || 'Player';
        $statusBar.textContent = `${esc(name)} is answering the Daily Double...`;
      }
    }
  }

  function onDailyDouble({ cat, row, value, playerSocketId, playerName }) {
    $clueOverlay.classList.add('active');
    playSound('select');

    const $ddSplash = document.getElementById('dd-splash');
    const $clueText = document.getElementById('clue-text');
    const $clueCat = document.getElementById('clue-cat-label');
    const $clueVal = document.getElementById('clue-value-label');
    const $buzzBtn = document.getElementById('buzz-btn');
    const $answerArea = document.getElementById('answer-area');
    const $resultDisplay = document.getElementById('result-display');
    const $ddWagerArea = document.getElementById('dd-wager-area');

    $buzzBtn.classList.remove('active');
    $answerArea.classList.remove('active');
    $resultDisplay.classList.remove('active');

    $ddSplash.classList.add('active');
    $clueText.textContent = '';
    $clueCat.textContent = '';
    $clueVal.textContent = '';

    // Mark used
    if (gameState) {
      const key = `${cat},${row}`;
      if (!gameState.usedClues.includes(key)) gameState.usedClues.push(key);
      renderBoard(gameState);
    }

    // Show wager UI if it's me
    if (playerSocketId === mySocketId) {
      setTimeout(() => {
        $ddSplash.classList.remove('active');
        $ddWagerArea.classList.add('active');
        const myPlayer = gameState?.players.find(p => p.socketId === mySocketId);
        const maxWager = gameState?.currentRound === 'jeopardy'
          ? Math.max(1000, myPlayer?.score || 0)
          : Math.max(2000, myPlayer?.score || 0);
        document.getElementById('dd-wager-input').max = maxWager;
        document.getElementById('dd-wager-input').placeholder = `$5 - $${maxWager}`;
        document.getElementById('dd-wager-input').focus();
      }, 1500);
    } else {
      setTimeout(() => {
        $ddSplash.classList.remove('active');
        $clueText.textContent = `${esc(playerName)} is wagering...`;
      }, 1500);
    }
  }

  document.getElementById('dd-wager-btn').onclick = () => {
    const val = parseInt(document.getElementById('dd-wager-input').value);
    if (isNaN(val) || val < 5) { alert('Minimum wager is $5'); return; }
    socket.emit('daily-double-wager', { amount: val });
    document.getElementById('dd-wager-area').classList.remove('active');
  };
  document.getElementById('dd-wager-input').onkeydown = (e) => {
    if (e.key === 'Enter') document.getElementById('dd-wager-btn').click();
  };

  function showBuzzer() {
    const $buzzBtn = document.getElementById('buzz-btn');
    const $answerArea = document.getElementById('answer-area');
    const $resultDisplay = document.getElementById('result-display');

    $resultDisplay.classList.remove('active');
    $answerArea.classList.remove('active');
    $buzzBtn.classList.add('active');
  }

  document.getElementById('buzz-btn').onclick = () => {
    socket.emit('buzz-in');
    document.getElementById('buzz-btn').classList.remove('active');
  };

  // Spacebar to buzz
  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space' && document.getElementById('buzz-btn').classList.contains('active')) {
      e.preventDefault();
      document.getElementById('buzz-btn').click();
    }
  });

  function onBuzzerResult({ playerId, playerName, isAI }) {
    const $buzzBtn = document.getElementById('buzz-btn');
    $buzzBtn.classList.remove('active');
    stopClueTimer();
    stopLoop('tick');
    playSound('buzz');

    if (playerId === mySocketId) {
      hasBuzzedThisClue = true;
      showAnswerInput(10);
    } else {
      const $answerArea = document.getElementById('answer-area');
      const $resultDisplay = document.getElementById('result-display');
      $answerArea.classList.remove('active');
      $resultDisplay.classList.remove('active');
      const label = isAI ? `${esc(playerName)} buzzed in!` : `${esc(playerName)} is answering...`;
      $statusBar.textContent = label;
      document.getElementById('answering-label').textContent = label;
    }
  }

  // ─── Global clue timer bar ──────────────────────────────────
  let clueTimerInterval = null;
  const $clueTimerBar = document.getElementById('clue-timer-bar');

  function startClueTimer(seconds) {
    stopClueTimer();
    $clueTimerBar.style.width = '100%';
    const start = Date.now();
    clueTimerInterval = setInterval(() => {
      const left = Math.max(0, seconds - (Date.now() - start) / 1000);
      $clueTimerBar.style.width = `${(left / seconds) * 100}%`;
      if (left <= 0) stopClueTimer();
    }, 50);
  }

  function stopClueTimer() {
    if (clueTimerInterval) { clearInterval(clueTimerInterval); clueTimerInterval = null; }
    $clueTimerBar.style.width = '0%';
  }

  function showAnswerInput(seconds) {
    const $answerArea = document.getElementById('answer-area');
    const $answerInput = document.getElementById('answer-input');
    const $timer = document.getElementById('answer-timer');

    $answerArea.classList.add('active');
    document.getElementById('answering-label').textContent = 'Your answer:';
    $answerInput.value = '';
    $answerInput.focus();

    $timer.textContent = seconds;

    clearAnswerTimer();
    startClueTimer(seconds);
    const start = Date.now();
    answerTimerInterval = setInterval(() => {
      const left = Math.max(0, seconds - (Date.now() - start) / 1000);
      $timer.textContent = Math.ceil(left);
      if (left <= 0) clearAnswerTimer();
    }, 100);
  }

  function clearAnswerTimer() {
    if (answerTimerInterval) { clearInterval(answerTimerInterval); answerTimerInterval = null; }
  }

  document.getElementById('answer-submit-btn').onclick = () => {
    const answer = document.getElementById('answer-input').value.trim();
    if (!answer) return;
    socket.emit('submit-answer', { answer });
    document.getElementById('answer-area').classList.remove('active');
    clearAnswerTimer();
  };
  document.getElementById('answer-input').onkeydown = (e) => {
    if (e.key === 'Enter') document.getElementById('answer-submit-btn').click();
  };

  function onBuzzerExpired({ correctAnswer }) {
    const $buzzBtn = document.getElementById('buzz-btn');
    $buzzBtn.classList.remove('active');
    stopClueTimer();
    clearAnswerTimer();
    stopLoop('tick');
    playSound('timesup');

    const $resultDisplay = document.getElementById('result-display');
    const $resultLabel = document.getElementById('result-label');
    const $resultAnswer = document.getElementById('result-answer');
    const $resultScoreChange = document.getElementById('result-score-change');
    const $answerArea = document.getElementById('answer-area');
    $answerArea.classList.remove('active');

    $resultDisplay.classList.add('active');
    $resultLabel.textContent = 'Time\'s Up!';
    $resultLabel.className = 'result-label incorrect';
    $resultAnswer.textContent = correctAnswer;
    $resultScoreChange.textContent = '';

    hostSay(`The correct answer is ${correctAnswer}`);
  }

  function onAnswerResult({ playerId, playerName, playerAnswer, correctAnswer, correct, scoreChange, newScore, isAI }) {
    const $resultDisplay = document.getElementById('result-display');
    const $resultLabel = document.getElementById('result-label');
    const $resultAnswer = document.getElementById('result-answer');
    const $resultScoreChange = document.getElementById('result-score-change');
    const $answerArea = document.getElementById('answer-area');
    const $buzzBtn = document.getElementById('buzz-btn');

    $answerArea.classList.remove('active');
    $buzzBtn.classList.remove('active');
    clearAnswerTimer();
    stopClueTimer();
    stopLoop('tick');

    playSound(correct ? 'correct' : 'incorrect');

    $resultDisplay.classList.add('active');

    if (isAI && correct) {
      $resultLabel.textContent = `${esc(playerName)}: "${esc(playerAnswer)}"`;
    } else if (isAI && !correct) {
      $resultLabel.textContent = `${esc(playerName)}: Incorrect`;
    } else {
      $resultLabel.textContent = correct ? 'Correct!' : 'Incorrect';
    }
    $resultLabel.className = `result-label ${correct ? 'correct' : 'incorrect'}`;

    // Show correct answer on incorrect responses (only if server sent it)
    $resultAnswer.textContent = (!correct && correctAnswer) ? correctAnswer : '';

    const sign = scoreChange >= 0 ? '+' : '';
    $resultScoreChange.textContent = `${esc(playerName)}: ${sign}$${Math.abs(scoreChange)}`;
    $resultScoreChange.style.color = correct ? 'var(--correct)' : 'var(--incorrect)';

    // TTS announce result
    if (correct) {
      hostSay(`${playerName}, that is correct!`);
    } else if (!correct && correctAnswer) {
      // Only announce correct answer if buzzer won't reopen (server handles that)
    }
  }

  function onScoresUpdate(players) {
    if (gameState) gameState.players = players;
    renderScores(players, gameState?.controllingPlayer);
  }

  // ─── Final Jeopardy ──────────────────────────────────────
  function onFinalCategory({ category }) {
    $clueOverlay.classList.remove('active');
    $fjOverlay.classList.add('active');
    document.getElementById('fj-category').textContent = category;
    document.getElementById('fj-clue').textContent = '';
    document.getElementById('fj-wager-area').classList.remove('active');
    document.getElementById('fj-answer-area').classList.remove('active');
    document.getElementById('fj-waiting').textContent = 'Get ready...';
    document.getElementById('fj-reveals').innerHTML = '';

    playSound('intro');
    hostSay(`The Final Jeopardy category is: ${category}`);
  }

  function onFinalClue({ category, clue }) {
    document.getElementById('fj-category').textContent = category;
    document.getElementById('fj-clue').textContent = clue;
    document.getElementById('fj-wager-area').classList.remove('active');
    document.getElementById('fj-waiting').textContent = '';

    // TTS read the clue, then start the think music
    speechSynthesis.cancel();
    hostSay(clue, () => {
      playLoop('think');
    });

    // Show answer input
    const $fjAnswerArea = document.getElementById('fj-answer-area');
    $fjAnswerArea.classList.add('active');
    document.getElementById('fj-answer-input').value = '';
    document.getElementById('fj-answer-input').focus();

    // 30s timer
    const $timer = document.getElementById('fj-timer');
    const $timerBar = document.getElementById('fj-timer-bar');
    const start = Date.now();
    if (fjTimerInterval) clearInterval(fjTimerInterval);
    fjTimerInterval = setInterval(() => {
      const left = Math.max(0, 30 - (Date.now() - start) / 1000);
      $timer.textContent = Math.ceil(left);
      $timerBar.style.width = `${(left / 30) * 100}%`;
      if (left <= 0) {
        clearInterval(fjTimerInterval);
        stopLoop('think');
        playSound('timesup');
      }
    }, 100);
  }

  // When phase changes to finalWager, show wager area
  socket.on('phase-change', ({ phase }) => {
    if (phase === 'finalWager') {
      document.getElementById('fj-waiting').textContent = '';
      document.getElementById('fj-wager-area').classList.add('active');
      const myPlayer = gameState?.players.find(p => p.socketId === mySocketId);
      const maxWager = Math.max(0, myPlayer?.score || 0);
      document.getElementById('fj-wager-input').max = maxWager;
      document.getElementById('fj-wager-input').placeholder = `$0 - $${maxWager}`;
      document.getElementById('fj-wager-input').focus();
    }
  });

  document.getElementById('fj-wager-btn').onclick = () => {
    const val = parseInt(document.getElementById('fj-wager-input').value);
    if (isNaN(val) || val < 0) { alert('Enter a valid wager'); return; }
    socket.emit('final-jeopardy-wager', { amount: val });
    document.getElementById('fj-wager-area').classList.remove('active');
    document.getElementById('fj-waiting').textContent = 'Waiting for other players...';
  };
  document.getElementById('fj-wager-input').onkeydown = (e) => {
    if (e.key === 'Enter') document.getElementById('fj-wager-btn').click();
  };

  document.getElementById('fj-answer-btn').onclick = () => {
    const answer = document.getElementById('fj-answer-input').value.trim();
    if (!answer) return;
    socket.emit('final-jeopardy-answer', { answer });
    document.getElementById('fj-answer-area').classList.remove('active');
    document.getElementById('fj-waiting').textContent = 'Waiting for other players...';
    if (fjTimerInterval) clearInterval(fjTimerInterval);
    stopLoop('think');
  };
  document.getElementById('fj-answer-input').onkeydown = (e) => {
    if (e.key === 'Enter') document.getElementById('fj-answer-btn').click();
  };

  function onFinalWagerSubmitted({ playerName, total, needed }) {
    document.getElementById('fj-waiting').textContent = `Wagers: ${total}/${needed}`;
  }

  function onFinalAnswerSubmitted({ playerName, total, needed }) {
    document.getElementById('fj-waiting').textContent = `Answers: ${total}/${needed}`;
  }

  function onFinalReveal({ playerName, answer, wager, correct, scoreChange, newScore }) {
    stopLoop('think');
    playSound(correct ? 'correct' : 'incorrect');

    const $reveals = document.getElementById('fj-reveals');
    const card = document.createElement('div');
    card.className = 'fj-reveal-card';
    card.innerHTML = `
      <div class="fj-reveal-name">${esc(playerName)}</div>
      <div class="fj-reveal-answer">"${esc(answer || '(no answer)')}"</div>
      <div class="fj-reveal-wager" style="color:${correct ? 'var(--correct)' : 'var(--incorrect)'}">
        ${correct ? '+' : '-'}$${wager}
      </div>
      <div class="fj-reveal-score">$${newScore.toLocaleString()}</div>
    `;
    $reveals.appendChild(card);
  }

  // ─── Game Over ──────────────────────────────────────────
  function onGameOver({ standings }) {
    $fjOverlay.classList.remove('active');
    $clueOverlay.classList.remove('active');
    $gameoverOverlay.classList.add('active');

    // Stop all sounds
    stopLoop('think');
    stopLoop('tick');
    speechSynthesis.cancel();

    const $list = document.getElementById('standings-list');
    $list.innerHTML = '';
    standings.forEach((p, i) => {
      const li = document.createElement('li');
      li.className = 'standings-item';
      li.innerHTML = `
        <span class="standings-rank">#${i + 1}</span>
        <span class="standings-name" style="color:${p.color}">${esc(p.name)}</span>
        <span class="standings-score">$${p.score.toLocaleString()}</span>
      `;
      $list.appendChild(li);
    });

    // Announce winner
    if (standings.length > 0) {
      hostSay(`Game over! ${standings[0].name} wins with $${standings[0].score}!`);
    }
  }

  document.getElementById('btn-play-again').onclick = () => {
    // Stop all sounds and reset state
    stopLoop('think');
    stopLoop('tick');
    speechSynthesis.cancel();
    Object.values(sfx).forEach(s => { s.pause(); s.currentTime = 0; s.loop = false; });
    lastAnnouncedRound = null;
    hasBuzzedThisClue = false;

    $gameoverOverlay.classList.remove('active');
    $game.classList.remove('active');
    $lobby.style.display = 'flex';
    hideAllLobbyCards();
    $lobbyChoice.style.display = 'flex';
    roomId = null;
    isHost = false;
    isSinglePlayer = false;
    gameState = null;
    history.replaceState(null, '', '/jeopardy');
    socket.emit('leave-room');
  };

  // ─── Rendering helpers ──────────────────────────────────────
  function renderScores(players, controllingPlayer) {
    $scoresBar.innerHTML = '';
    for (const p of players) {
      const div = document.createElement('div');
      div.className = `score-item${p.socketId === controllingPlayer ? ' controlling' : ''}`;
      div.innerHTML = `
        <div class="score-name" style="color:${p.color}">${esc(p.name)}</div>
        <div class="score-value${p.score < 0 ? ' negative' : ''}">$${p.score.toLocaleString()}</div>
      `;
      $scoresBar.appendChild(div);
    }
  }

  function renderRoundIndicator(round) {
    const labels = { jeopardy: 'Jeopardy!', doubleJeopardy: 'Double Jeopardy!', finalJeopardy: 'Final Jeopardy!' };
    $roundIndicator.textContent = labels[round] || round;
  }

  function renderBoard(state) {
    $board.innerHTML = '';
    const round = state.currentRound;
    const categories = round === 'jeopardy'
      ? state.gameData.jRound.categories
      : (round === 'doubleJeopardy' ? state.gameData.djRound.categories : []);
    const usedSet = new Set(state.usedClues);
    const isSelector = state.controllingPlayer === mySocketId && state.phase === 'selectingClue';
    const values = round === 'jeopardy' ? [200, 400, 600, 800, 1000] : [400, 800, 1200, 1600, 2000];

    for (const cat of categories) {
      const div = document.createElement('div');
      div.className = 'board-category';
      div.textContent = cat;
      $board.appendChild(div);
    }

    for (let row = 1; row <= 5; row++) {
      for (let catIdx = 0; catIdx < 6; catIdx++) {
        const key = `${catIdx},${row}`;
        const used = usedSet.has(key);
        const cell = document.createElement('div');
        cell.className = `board-cell${used ? ' used' : ''}${!isSelector ? ' disabled' : ''}`;
        cell.textContent = used ? '' : `$${values[row - 1]}`;
        if (!used && isSelector) {
          cell.onclick = () => {
            socket.emit('select-clue', { cat: catIdx, row });
          };
        }
        $board.appendChild(cell);
      }
    }
  }

  function renderStatusBar(state) {
    const phase = state.phase;
    if (phase === 'selectingClue') {
      const name = state.controllingPlayerName || 'Player';
      if (state.controllingPlayer === mySocketId) {
        $statusBar.textContent = 'Your turn — select a clue!';
      } else {
        $statusBar.textContent = `${esc(name)} is selecting a clue...`;
      }
    } else if (phase === 'readingClue') {
      $statusBar.textContent = 'Read the clue...';
    } else if (phase === 'buzzerOpen') {
      $statusBar.textContent = 'BUZZ IN!';
    } else if (phase === 'playerAnswering') {
      const name = state.answeringPlayerName || 'Player';
      $statusBar.textContent = `${esc(name)} is answering...`;
    } else {
      $statusBar.textContent = '';
    }
  }

  function esc(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // ─── CPU player controls (exposed globally for onclick) ───
  window.addCPU = function(difficulty) {
    socket.emit('add-cpu', { difficulty });
  };
  window.removeCPU = function(playerId) {
    socket.emit('remove-cpu', { playerId });
  };
})();
</script>
</body>
</html>
